# DarkSwap WebAssembly Build Guide

This guide explains how to build the DarkSwap WebAssembly bindings from the Rust SDK.

## Prerequisites

Before building the WebAssembly bindings, ensure you have the following prerequisites installed:

- **Rust** (1.70.0 or later)
- **wasm-pack** (0.10.0 or later)
- **Node.js** (16.0.0 or later)
- **npm** (8.0.0 or later)

### Installing Rust

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

### Installing wasm-pack

```bash
cargo install wasm-pack
```

### Installing Node.js and npm

Download and install Node.js from [https://nodejs.org/](https://nodejs.org/)

## Building the WebAssembly Bindings

### Using the Build Script

The easiest way to build the WebAssembly bindings is to use the provided build script:

```bash
./build.sh
```

This will build the WebAssembly module in debug mode and place it in the `pkg` directory.

### Build Options

The build script supports several options:

- `--release`: Build in release mode (optimized for production)
- `--target-dir DIR`: Specify the output directory for the WebAssembly module
- `--features LIST`: Enable specific features (comma-separated list)

Example:

```bash
./build.sh --release --target-dir dist --features "webrtc,runes"
```

### Manual Build Process

If you prefer to build the WebAssembly bindings manually, follow these steps:

1. Navigate to the Rust SDK directory:

```bash
cd ../darkswap-sdk
```

2. Build the WebAssembly module:

```bash
wasm-pack build --target web --out-dir "../darkswap-web-sys/pkg"
```

3. Copy the WebAssembly module to the src/wasm directory:

```bash
mkdir -p ../darkswap-web-sys/src/wasm
cp -r pkg/* ../darkswap-web-sys/src/wasm/
```

4. Create a TypeScript wrapper for the WebAssembly module:

```bash
cd ../darkswap-web-sys
```

Create a file at `src/wasm/darkswap_sdk.ts` with the following content:

```typescript
/**
 * DarkSwap SDK WebAssembly Module
 * 
 * This file is automatically generated by the build script.
 * Do not edit this file directly.
 */

import * as wasm from './darkswap_sdk_bg.wasm';
import { initSync } from './darkswap_sdk_bg.js';

/**
 * Initialize the WebAssembly module
 */
export default async function init(): Promise<any> {
    // Initialize the WebAssembly module
    initSync(wasm);
    
    // Import the WebAssembly module
    const module = await import('./darkswap_sdk_bg.js');
    
    return module;
}
```

5. Build the TypeScript code:

```bash
npm run build
```

## WebAssembly Module Structure

The WebAssembly module consists of the following files:

- `darkswap_sdk_bg.wasm`: The WebAssembly binary
- `darkswap_sdk_bg.js`: JavaScript glue code for the WebAssembly binary
- `darkswap_sdk.js`: JavaScript entry point for the WebAssembly module
- `darkswap_sdk.d.ts`: TypeScript type definitions for the WebAssembly module

## Rust SDK Configuration

The Rust SDK must be configured to build for WebAssembly. This is done in the `Cargo.toml` file:

```toml
[lib]
crate-type = ["cdylib", "rlib"]

[features]
default = ["console_error_panic_hook"]
webrtc = ["dep:webrtc"]
runes = ["dep:runes"]

[dependencies]
wasm-bindgen = "0.2.84"
console_error_panic_hook = { version = "0.1.7", optional = true }
```

## WebAssembly Optimization

For production builds, you should optimize the WebAssembly binary for size and performance:

```bash
./build.sh --release
```

This will apply the following optimizations:

- **Code size reduction**: Removes unused code and optimizes for size
- **Performance optimization**: Applies performance optimizations
- **Tree shaking**: Removes unused exports
- **Minification**: Minifies the JavaScript glue code

## Troubleshooting

### wasm-pack not found

If you get an error that `wasm-pack` is not found, make sure it's installed and in your PATH:

```bash
cargo install wasm-pack
```

### Rust compilation errors

If you get Rust compilation errors, make sure you have the latest version of Rust:

```bash
rustup update
```

### JavaScript import errors

If you get JavaScript import errors, make sure the WebAssembly module is correctly built and copied to the `src/wasm` directory:

```bash
ls -la src/wasm
```

You should see the following files:

```
darkswap_sdk_bg.wasm
darkswap_sdk_bg.js
darkswap_sdk.js
darkswap_sdk.d.ts
darkswap_sdk.ts
```

## Using the WebAssembly Module

After building the WebAssembly module, you can use it in your application:

```typescript
import darkswap from 'darkswap-web-sys';

async function main() {
    // Initialize the SDK
    await darkswap.initialize();
    
    // Connect to the P2P network
    await darkswap.connect();
    
    // Use the SDK
    const peers = await darkswap.getPeers();
    console.log('Connected peers:', peers);
}

main().catch(console.error);
```

For more information on using the WebAssembly module, see the [API documentation](./API.md).